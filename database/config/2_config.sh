#!/bin/bash
set +e

# DEFINA A VARI√ÅVEL ABAIXO COMO 0 SE QUISER IGNORAR OS ERROS.
exit_on_error=1;

echo -e "Vamos l√°...\n";

declare -a segmentos=(
  "preconfig"
  "types"
  "tables"
  "routines"
  "views"
  "triggers"
  "extra"
  "seed"
);

gcount=0;

for s in "${segmentos[@]}"; do
  lcount=0;

  echo -e "====================> $s\n";
  file="/opt/sql/$s/__create__.txt";

  if [[ ! -f "$file" ]]; then
    echo -e "File $file not found\n";
    exit 1;
  fi

  while read buff; do
    if [[ -z "$buff" || ${buff:0:1} == '#' ]]; then
      continue;
    fi

    obj="/opt/sql/$s/$buff.sql";
    echo -e "üîÑ  $obj";
    psql -U postgres -d andifes -v ON_ERROR_STOP=on -f $obj;
    exit_status=$?;

    if [[ $exit_status -ne 0 ]]; then
      echo -e "
      ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£Ü‚¢Ä‚£∂‚°∂‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
      ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢à‚£ø‚¢∏‚†ü‚£†‚£∂‚°∑‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
      ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£Ä‚†Ä‚¢Ä‚£†‚†¥‚†¥‚†∂‚†ö‚†ø‚†ø‚†æ‚†≠‚£§‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
      ‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†¥‚¢ã‚°Ω‚†ö‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ô‚†¢‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
      ‚†Ä‚†Ä‚¢Ä‚°î‚†Å‚°∞‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚†ö‚†õ‚£ñ‚†Ä‚†Ä‚†Ä‚†Ä
      ‚†Ä‚¢Ä‚°è‚†Ä‚°º‚¢°‚†ö‚°õ‚†í‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†ñ‚†õ‚†õ‚†≤‚°Ñ‚†ê‚¢Ø‚†Å‚†Ä‚†Ä‚†π‚°ß‚†Ä‚†Ä‚†Ä
      ‚†Ä‚£∏‚†Ä‚†Ä‚°á‚†ò‚†¶‚£≠‚°§‚¢ü‚°§‚†§‚£Ä‚†Ä‚†£‚£Ä‚°â‚¢Å‚£Ä‚†ü‚†Ä‚†Ä‚¢∑‚†Ä‚†Ä‚†Ä‚†ô‚£ó‚†Ä‚†Ä
      ‚†Å‚¢ª‚†Ä‚†Ä‚¢∑‚¢Ä‚°î‚†â‚¢ª‚°Ö‚£Ä‚£§‚°à‚†ô‚†í‚†∫‚†Ø‚°ç‚†Å‚†Ä‚†Ä‚†Ä‚¢∏‚°Ü‚†Ä‚†Ä‚†Ä‚†ò‚°∂‚†Ñ
      ‚†Ä‚£à‚£ß‚†¥‚†ö‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£∞‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚£∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚£î
      ‚£æ‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ß‚£§‚°§‚†¥‚†ñ‚†ã‚¢π‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∑
      ‚£ø‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ê‚£ª‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£º
      ‚†ô‚†ë‚£§‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†Ä‚†Ä‚¢Ñ‚£ê‚†¥‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚¢Ü‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚†ü
      ‚†Ä‚†Ä‚†Ä‚£ë‚°ü‚†õ‚†õ‚†õ‚†õ‚†õ‚†õ‚†â‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢¥‚°æ‚†ã‚†Ä
      ‚†Ä‚†Ä‚†Ä‚°æ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚°á‚†Ä‚†Ä
      ‚†Ä‚†Ä‚£∞‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä
      ‚†Ä‚†Ä‚†∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†É‚†Ä‚†É \n
";
      echo -e "‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå  Ocorreu um erro  ‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå‚ùå";
      echo -e "üìÑ  $obj";
      echo -e "‚ÑπÔ∏è  Verifique a mensagem de erro acima. Boa sorte!\n\n\n";

      if [[ $exit_on_error -eq 1 ]]; then
        echo -e "‚ÑπÔ∏è  Se precisar ignorar os erros temporariamente, verifique o arquivo database/config/2_config.sh\n";
        exit 1;
      fi
    else
      echo -e "‚úÖ  OK!\n";
    fi

    lcount=$((lcount+1));
  done < "$file";

  echo -e "$s: $lcount arquivos executados.\n";
  gcount=$((gcount+lcount));
done

echo -e "
     .=gp.
   .\'/\$\$\$\$
   || \"TP\"
   ||          .:                 ____
   ||       .-' |                /\' .\    _____
   ||    .-'    |               /: \___\  / .  /\\
   ||    |      !____           \' / . / /____/..\\
   ||    |   .-'  .-'            \/___/  \'  '\  /
   ||    '.____.-'(                       \'__'\/
   ||     \  /  /__\\
   ||      )(
  |::|    /__\\
  |::|
  |  | =========================================================== |

            ____    ____ _  _ ___  _ ____ ____ ____
            |___ __ |__| |\ | |  \ | |___ |___ [__
            |___    |  | | \| |__/ | |    |___ ___]

\n";
echo -e "üéâ  Banco de dados inicializado com sucesso";
echo -e "üìä  $gcount arquivos executados no total\n";
